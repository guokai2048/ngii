@{
    ViewBag.Title = "日志管理";
    Layout = "~/Views/Shared/_LayoutIndexEasyui.cshtml";
}
<script>
    $(function () {
        GetGrid();
    });

    //加载表格
    function GetGrid() {
        var queryJson = $("#filter-form").GetWebControls();
        queryJson["CategoryId"] = 1;
        var $gridTable = $("#gridTable");
        $gridTable.datagrid({
            url: "../../SystemManage/Log/GetPageListV1?CategoryId=1",
            queryParams: {
                splitPage: $("#filter-form").setQueryParmsAll()
            },
            fit: true,
            idField: 'LogId',
            rownumbers: true,
            pagination: true,
            pageSize: 20,
            pageList: [20, 50, 100],
            sortName: 'OperateTime',
            sortOrder: 'desc',
            singleSelect: true,
            nowrap: true,
            emptyMsg: '<div style="color:red;padding:4px;border-bottom:#ccc 1px solid;">无相关数据!</div>',
            columns: [[
                { title: "主键", field: "LogId", hidden: true },
                {
                    title: "操作时间", field: "OperateTime", width: 150, align: "left",
                    formatter: function (value, row, index) {
                        return formatDate(value, 'yyyy-MM-dd hh:mm:ss');
                    }
                },
                { title: "操作用户", field: "OperateAccount", width: 150, align: "left" },
                { title: "IP地址", field: "IPAddress", width: 150, align: "left" },
                { title: "功能模块", field: "Module", width: 150, align: "left" },
                { title: "操作类型", field: "OperateType", width: 70, align: "center" },
                {
                    title: "执行结果", field: "ExecuteResult", width: 70, align: "center",
                    formatter: function (value, row, index) {
                        if (value == '1') {
                            return "<span class=\"label label-success\">成功</span>";
                        } else {
                            return "<span class=\"label label-danger\">失败</span>";
                        }
                    }
                },
                {
                    title: '日志', field: 'paicodeLook', width: 60, align: 'left', hidden: false,
                    formatter: function (value, row, index) {
                        var dataUrl = '<a href="javascript:void(0)" onclick="lookOrder(\'' + index + '\')">查看</a>';
                        return dataUrl;
                    }
                },
                { title: "执行结果描述", field: "ExecuteResultJson", width: 350, align: "left" }
            ]]
        });
        //$gridTable.authorizeColModel();
        //点击时间范围（今天、近7天、近一个月、近三个月）
        $("#time_horizon a.btn-default").click(function () {
            $("#time_horizon a.btn-default").removeClass("active");
            $(this).addClass("active");
            switch ($(this).attr('data-value')) {
                case "1"://今天
                    $("#StartTime").val("@DateTime.Now.ToString("yyyy-MM-dd")");
                    $("#EndTime").val("@DateTime.Now.ToString("yyyy-MM-dd")");
                    break;
                case "2"://近7天
                    $("#StartTime").val("@DateTime.Now.AddDays(-7).ToString("yyyy-MM-dd")");
                    $("#EndTime").val("@DateTime.Now.ToString("yyyy-MM-dd")");
                    break;
                case "3"://近一个月
                    $("#StartTime").val("@DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd")");
                    $("#EndTime").val("@DateTime.Now.ToString("yyyy-MM-dd")");
                    break;
                case "4"://近三个月
                    $("#StartTime").val("@DateTime.Now.AddMonths(-3).ToString("yyyy-MM-dd")");
                    $("#EndTime").val("@DateTime.Now.ToString("yyyy-MM-dd")");
                    break;
                default:
                    break;
            }
            $("#SelectedStartTime").html($("#StartTime").val());
            $("#SelectedEndTime").html($("#EndTime").val());
            SearchEvent();
        });
        //查询点击事件
        $("#btn_Search").click(function () {
            SearchEvent();
            $(".ui-filter-text").trigger("click");
            $("#SelectedStartTime").html($("#StartTime").val());
            $("#SelectedEndTime").html($("#EndTime").val());
        });
        //左边分类点击事件
        $(".profile-nav li").click(function () {
            SearchEvent();
        })
    }
    //明细日志
    function lookOrder(indexI) {

        var rows = $("#gridTable").datagrid("getRows");
        var LogId = rows[indexI].LogId;
        if (LogId) {
            dialogOpen({
                id: "FormLog",
                title: '查看日志明细',
                url: '/SystemManage/Log/Form?LogId=' + LogId,
                width: "800px",
                height: "500px",
                callBack: function (iframeId) {

                }
            });
        }

    }

    //查询表格函数
    function SearchEvent() {

        console.log($("#filter-form").setQueryParmsAll());
        var CategoryId = $(".profile-nav").find('li.active').attr('data-value');
        if (!CategoryId) { CategoryId = 1 }

        $("#gridTable").datagrid({
            url: "../../SystemManage/Log/GetPageListV1?CategoryId=" + CategoryId,
            pageSize: 20,
            pageList: [20, 50, 100],
            queryParams: {
                splitPage: $("#filter-form").setQueryParmsAll()
            },
        });
    }
    //清空日志
    function btn_RemoveLog() {
        var categoryId = $(".profile-nav").find('li.active').attr('data-value');
        var categoryName = $(".profile-nav").find('li.active').html();
        dialogOpen({
            id: "RemoveLog",
            title: '清空' + categoryName,
            url: '/SystemManage/Log/RemoveLog?categoryId=' + categoryId,
            width: "400px",
            height: "200px",
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }
        });
    }
    //导出
    function btn_export() {
        dialogOpen({
            id: "ExcelIExportDialog",
            title: '导出Excel数据',
            url: '/Utility/ExcelExportForm?gridId=gridTable',
            width: "500px",
            height: "380px",
            callBack: function (iframeId) {
                top.frames[iframeId].AcceptClick();
            }, btn: ['导出Excel', '关闭']
        });
    }
</script>
<div class="easyui-layout" data-options="fit:true">
    <div data-options="region:'west',split:true" style="width: 200px;">
        <div class="west-Panel">
            <div class="profile-nav">
                <ul style="padding-top: 20px;">
                    <li class="active" data-value="1">登录日志</li>
                    <li data-value="2">访问日志</li>
                    <li data-value="3">操作日志</li>
                    <div class="divide"></div>
                    <li data-value="4">异常日志</li>
                    <li data-value="5">授权日志</li>
                </ul>
            </div>
        </div>
    </div>
    <div data-options="region:'center',border:false" style="background:#fafafa;">
        <div class="easyui-layout" data-options="fit:true">
            <div data-options="region:'north',border:false" style="height:60px;overflow: hidden;">
                <div class="titlePanel">
                    <!-- 注：position必须修改为fixed，下拉菜单才不会被隐藏-->
                    <div class="title-search" style="position:fixed;">
                        <table>
                            <tr>
                                <td>查询条件</td>
                                <td style="padding-left: 10px;">
                                    <div class="ui-filter" style="width: 200px;">
                                        <div class="ui-filter-text">
                                            <strong id="SelectedStartTime">@DateTime.Now.AddDays(-1).ToString("yyyy-MM-dd")</strong>
                                            至 <strong id="SelectedEndTime">@DateTime.Now.ToString("yyyy-MM-dd")</strong>
                                        </div>
                                        <div id="searchbar" class="ui-filter-list" style="width: 350px;">
                                            <form>

                                                <table class="form" id="filter-form">

                                                    <tr>
                                                        <th class="formTitle">创建日期：</th>
                                                        <td class="formValue">
                                                            <input type="hidden" name="TimeString[0].Key" value="OperateTime" />
                                                            <div style="float: left; width: 45%;">
                                                                <input id="StartTime" name="TimeString[0].begionTime" readonly type="text"
                                                                       value="@DateTime.Now.AddDays(-1).ToString("yyyy-MM-dd")"
                                                                       class="form-control input-wdatepicker" onfocus="WdatePicker()">
                                                            </div>
                                                            <div style="float: left; width: 10%; text-align: center;">至</div>
                                                            <div style="float: left; width: 45%;">
                                                                <input id="EndTime" name="TimeString[0].endTime" readonly type="text"
                                                                       value="@CM.Util.Time.GetToday()"
                                                                       class="form-control input-wdatepicker" onfocus="WdatePicker()">
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="formTitle">操作用户：</td>
                                                        <td class="formValue">
                                                            <input type="hidden" name="Conditions[0].Key" value="OperateAccount" />
                                                            <input name="Conditions[0].Value" type="text" class="form-control">
                                                            <input type="hidden" name="Conditions[0].IsLike" value="true" />
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="formTitle">操作类型：</td>
                                                        <td class="formValue">
                                                            <input type="hidden" name="Conditions[1].Key" value="OperateType" />
                                                            <input name="Conditions[1].Value" type="text" class="form-control">
                                                            <input type="hidden" name="Conditions[1].IsLike" value="true" />
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td class="formTitle">功能模块：</td>
                                                        <td class="formValue">
                                                            <input type="hidden" name="Conditions[2].Key" value="Module" />
                                                            <input name="Conditions[2].Value" type="text" class="form-control">
                                                            <input type="hidden" name="Conditions[2].IsLike" value="true" />
                                                        </td>
                                                    </tr>

                                                    <tr>
                                                        <td class="formTitle">结果描述：</td>
                                                        <td class="formValue">
                                                            <input type="hidden" name="Conditions[3].Key" value="ExecuteResultJson" />
                                                            <input name="Conditions[3].Value" type="text" class="form-control">
                                                            <input type="hidden" name="Conditions[3].IsLike" value="true" />
                                                        </td>
                                                    </tr>


                                                </table>

                                            </form>
                                            <div class="ui-filter-list-bottom">
                                                <a id="btn_Reset" class="btn btn-default">&nbsp;重&nbsp;&nbsp;置</a>
                                                <a id="btn_Search" class="btn btn-primary">&nbsp;查&nbsp;&nbsp;询</a>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td style="padding-left: 10px;">
                                    <div id="time_horizon" class="btn-group">
                                        <a class="btn btn-default active" data-value="1">今天</a>
                                        <a class="btn btn-default" data-value="2">近7天</a>
                                        <a class="btn btn-default" data-value="3">近1个月</a>
                                        <a class="btn btn-default" data-value="4">近3个月</a>
                                    </div>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="toolbar">
                        <div class="btn-group">
                            <a id="lr-replace" class="btn btn-default" onclick="reload();"><i class="fa fa-refresh"></i>&nbsp;刷新</a>
                        </div>
                        <div class="btn-group">
                            <a id="lr-removelog" class="btn btn-default" onclick="btn_RemoveLog()"><i class="fa fa-eraser"></i>&nbsp;清空</a>
                            <a id="lr-export" class="btn btn-default" onclick="btn_export()"><i class="fa fa-sign-out"></i>&nbsp;导出</a>
                        </div>
                        <script>$('.toolbar').authorizeButton()</script>
                    </div>
                </div>
            </div>
            <div data-options="region:'center',border:false">
                <table id="gridTable"></table>
            </div>
        </div>
    </div>
</div>
